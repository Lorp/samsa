<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="utf-8">
<title>Samsa: Variable Font Inspector</title>

<script src="samsa-core.js"></script>

<link rel = "stylesheet" type = "text/css" href = "samsa-gui.css" />
</head>

<body>

<div id="container">

<div id="title"><h1>Samsa</h1>
	<div class="subtitle">
		variable font inspector<br>
		<a href="https://github.com/Lorp/samsa" title="Samsa on GitHub"><img width="15" height="15" src="images/GitHub-Mark-64px.svg"></a>
	</div>
	<div class="subtitle"></div>
</div>

<div id="font-file" class="inactive">
	&lt;drop a variable font here&gt;
</div>

<div id="controls">

	<div id="info" class="panel">
		<h2>Info</h2>
		<div></div>
	</div>

	<div id="axes" class="panel">
		<h2>Axes</h2>
		<div></div>
	</div>

	<div id="instances" class="panel">
		<h2>Instances <span class="icon" id="instances-as-grid">&#xf00a;</span> <span class="icon" id="instances-as-list">&#xf0c9;</span></h2>
		<div></div>
	</div>

	<div id="tvts" class="panel">
		<h2>Tuple Variations</h2>
		<div></div>
	</div>

	<div id="designspace" class="panel">
		<h2>Designspace</h2>
		<div></div>
	</div>

	<div id="stat" class="panel">
		<h2>STAT</h2>
		<div></div>
	</div>

	<div id="glyphs" class="panel">
		<h2>Glyphs</h2>
		<div></div>
	</div>

</div>

<div id="drawing"></div>

</div>


<script>


let GLOBAL = {
	vf: null, // maybe allow an array of fonts... select them with a drop down in info panel
};


function getCurrentFvs() {

	let fvs = {};
	document.querySelectorAll(".slider").forEach(slider => {
		let axis = slider.data.axis;
		fvs[axis.tag] = axis.min + slider.value * (axis.max - axis.min);
	});
	return fvs;
}


// TODO: this is needless duplication of what SamsaVF.addInstance() already does
// - we can assign the ui object in the options argument
function appendInstanceEl(instance, select) {

	let panel = document.querySelector("#instances>div");

	// create the instance DOM element
	let li = document.createElement("div"); // not li?

	// initialize instance if necessary
	if (instance === undefined) {
		//instance.fvs = ;
		instance = GLOBAL.vf.addInstance(getCurrentFvs(), { name: "Custom", ui: li }); // { name: "Custom", tuple: [] };

		/*
		GLOBAL.vf.axes.forEach((axis, a) => {
			instance.tuple[a] = GLOBAL.vf.axisNormalize(axis, instance.fvs[axis.tag]);
		});
		GLOBAL.vf.instances.push(instance);
		*/
	}

	// list view
	// - items are: bookmark icon, name, n axis settings
	panel.style.minWidth = "100%";
	panel.style.overflowX = "scroll";

	li.classList.add("instance");
	li.style.display = "grid";
	li.style.gridTemplateColumns = `1.5em 100px 1.5em repeat(${GLOBAL.vf.axisCount}, 70px)`;

	let cell0 = document.createElement("div");
	cell0.style.textAlign = "center";
	cell0.style.fontFamily = "FontAwesome";
	cell0.innerHTML = instance.namedInstance ? "&#xf02e;" : instance.default ? "&#xf015;" : "&#xf1de;"; // bookmark
	//let readonly = instance.default ? " readonly " : "";

	let cell1 = document.createElement("div");
	cell1.style.textAlign = "center";
	cell1.innerHTML = `<input value="${instance.name}" ${instance.default ? "readonly " : ""}style="width: 85px">`;

	let cell2 = document.createElement("div");
	cell2.classList.add("instantiate");
	cell2.setAttribute("title", "Instantiate TTF");
	cell2.style.textAlign = "center";
	cell2.style.fontFamily = "FontAwesome";
	cell2.style.cursor = "pointer";
	cell2.innerHTML = "&#xf56d;"

	li.appendChild(cell0);
	li.appendChild(cell1);
	li.appendChild(cell2);
	GLOBAL.vf.axes.forEach((axis, a) => {
		let axisCell = document.createElement("div");
		axisCell.style.fontSize = "75%";
		axisCell.style.textAlign = "right";
		axisCell.innerText = instance.fvs[axis.tag];
		li.appendChild(axisCell);
	});

	/*
	li.innerHTML += `<input value="${instance.name}"><br>`;
	li.innerHTML += "[";
	li.innerHTML += instance.tuple.join();
	li.innerHTML += "] ";
	li.innerHTML += JSON.stringify(instance.fvs);
	*/

	li.data = { instance: instance };

	// append the instance DOM element
	panel.appendChild(li);

	// make it active
	if (select) {
		setActiveInstance (GLOBAL.vf, li);
	}
}


function vfLoaded (font) {

	GLOBAL.vf = font;

	let panel;

	///////////////////////////////////////////////////////
	// info panel
	///////////////////////////////////////////////////////
	panel = document.querySelector("#info>div");
	panel.innerText = "";

	document.querySelector("#font-file").innerText = font.filename;

	panel.innerHTML += `${font.filename} (${font.filesize || "<em>n</em>"} bytes)<br>`;
	panel.innerHTML += `Full name: ${font.names[4]}<br>`;
	panel.innerHTML += `Other name: ${font.names[1]}<br>`;


	///////////////////////////////////////////////////////
	// axis panel
	///////////////////////////////////////////////////////
	panel = document.querySelector("#axes>div");
	panel.innerText = "";

	document.querySelector("#font-file").innerText = font.filename; // or font.names[6];

	// add each axis
	font.axes.forEach((axis, a) => {

		let label =  document.createElement("label");
		//label.innerHTML = `<span style="font-weight: bold; font-family: monospace;">${axis.tag}</span> ${axis.name}`;
		label.innerHTML = `<tt>${axis.tag}</tt> ${axis.name}`;
		panel.appendChild(label);

		let slider = document.createElement("input");
		slider.classList.add("slider");
		slider.setAttribute("type", "range");
		slider.setAttribute("min", 0.0);
		slider.setAttribute("max", 1.0);
		slider.setAttribute("step", 0.001);

		slider.data = {axis: axis};

		let boxes = document.createElement("label");

		panel.appendChild(slider);

	});

	// add button
	let addInstanceEl = document.createElement("button");
	addInstanceEl.innerText = "Add instance";
	addInstanceEl.id = "instance-add";
	panel.appendChild(addInstanceEl);
	//addInstanceEl.onclick = addInstance;

	addInstanceEl.addEventListener("click", ()=>{
		appendInstanceEl(undefined, true);
	});



	///////////////////////////////////////////////////////
	// instances panel
	///////////////////////////////////////////////////////
	panel = document.querySelector("#instances>div");
	panel.innerText = "";
	panel.style.backgroundClip = "border-box";
	panel.style.padding = "1px 0"; // necessary so the padding of the contents uses the panel’s background-color 

	let li = document.createElement("div");
	let fvsString = "";

	// add each instance
	font.instances.forEach((instance, i) => {
		appendInstanceEl(instance);
	});
	setActiveInstance(GLOBAL.vf); // without an instance parameter, it sets it to the default

	updateGlyphsPanel (); // use default glyphs

}



function updateGlyphsPanel(instance) {


	let font = GLOBAL.vf;

	///////////////////////////////////////////////////////
	// glyphs panel
	///////////////////////////////////////////////////////
	let panel = document.querySelector("#glyphs>div");
	panel.innerText = "";
	let scale = 0.05 * 1000 / font.unitsPerEm;

	for (let g=0; g < font.numGlyphs; g++) {

		let glyph = instance ? instance.glyphs[g] : font.glyphs[g];

		let glyphThumb = document.createElement("div");
		glyphThumb.classList.add("glyph-thumb");
		glyphThumb.setAttribute("id", `g-${g}`);


		if (glyph && glyph.numContours > 0) {

			// simple glyph
			let svg = SVG("svg");
			let svgPath = SVG("path");
			let svgg = SVG("g");

			svg.setAttributeNS(null, "width","90");
			svg.setAttributeNS(null, "height","90");
			svgg.setAttributeNS(null, "transform", `translate(20,60) scale(${scale},-${scale})`);
			
			//svgMarker.attr({markerWidth:20,markerHeight:20);

			svgPath.setAttributeNS(null, "d", getGlyphSVGpath(glyph));

			svg.appendChild(svgg);


			// glyph
			svgg.appendChild(svgPath);

			// x and y axes

			glyphThumb.appendChild(svg);
		}
		else if (glyph && glyph.numContours < 0) {

		}

		panel.appendChild(glyphThumb);


		let label = document.createElement("label");
		label.innerText = g;

		glyphThumb.appendChild(label);

	}


}

function setAxes (font, fvs) {
	

	let sliders = document.querySelectorAll(".slider");
	font.axes.forEach((axis, a) => {

		if (axis.min > axis.max)
			return;

		let val = fvs[axis.tag];
		if (val < axis.min)
			val = axis.min;
		if (val > axis.max)
			val = axis.max;

		sliders[a].value = (val - axis.min) / (axis.max - axis.min);
	});
}



function setActiveInstance (font, target) {

	document.querySelectorAll(".instance").forEach((el, i) => {

		let instance = font.instances[i];

		// update instance ui
		if (el == target || (!target && font.instances[i].default)) {
			el.classList.add("active");
			setAxes (font, el.data.instance.fvs);
			instanceApplyVariations (font, instance);

			updateGlyphsPanel (instance);

		}
		else {
			el.classList.remove("active");
			//target.data.selected = true;
		}
	});
}




document.onclick = function (event) {


	// about target
	// - via the method of assignment in the if(), target gets the desired element rather than a child (or grandchild) that in fact received the event
	// - the closest(x) method is great: we find whether event.target happened on something within something selected by x
	// - order matters! (e.g. an icon within an instance row must be handled before the instance row itself)
	let target;


	if (event.target == document.querySelector("#font-file")) {
	//if (target = event.target.closest("#font-file")) {
		// debug hack to load MutatorSans easily
		let vf = new SamsaVF({

			fontFamily: "FontNameShouldGoHere",
			url: "fonts/MutatorSans.ttf",
			callback: vfLoaded,
		});
	}

	else if (target = event.target.closest("#controls .panel .instantiate")) {

		// create and download the instance		
		let instanceEl = target.closest(".instance");
		let instance = instanceEl.data.instance;

		GLOBAL.vf.makeInstance(instance); // creates instance.static

		//window.open (`data:font/ttf;base64,${uint8ToBase64(instance.static)}`, "_blank"); // this method wasn’t great

		let fauxLink = document.createElement("a");
		fauxLink.download = GLOBAL.vf.filename;
		//fauxLink.href = "data:font/ttf;base64," + uint8ToBase64(instance.static);

		let str = btoa(instance.static)
		console.log (typeof str);
		console.log (str);
		fauxLink.href = "data:font/ttf;base64," + str;
		document.body.appendChild(fauxLink); // needed for Firefox, not Chrome or Safari
		fauxLink.click();
		fauxLink.remove();

	}

	else if (target = event.target.closest(".instance")) {

		setActiveInstance(GLOBAL.vf, target);
	}

	else if (target = event.target.closest(".ctrl-pt")) {
		console.log("click pt" + target);
	}

	else if (target = event.target.closest("#controls .panel>h2")) {
		// toggle display of panel when panel header is clicked
		let panelDiv = target.parentNode.querySelector("div");
		console.log (panelDiv);
		if (panelDiv) {
			if (panelDiv.style.display == "none") {
				panelDiv.style.display = "block";
			}
			else if (panelDiv.style.display = "block")
				panelDiv.style.display = "none";	
		}
	}

	else if (target = event.target.closest(".glyph-thumb")) {

		font = GLOBAL.vf;

		let scale = 0.5 * 1000 / font.unitsPerEm;

		let comps = target.id.split("-");
		let g = comps[1];
		let glyph = font.glyphs[g];


		// clear main window and tvts panel
		let drawing = document.querySelector("#drawing");
		drawing.innerHTML = "";
		let panel = document.querySelector("#tvts>div");
		panel.innerHTML = "";


		// draw the big glyph
		if (glyph.numContours > 0) {

			let svg = SVG("svg");
			let svgPath = SVG("path");
			let svgg = SVG("g");

			svg.setAttributeNS(null, "width","1000");
			svg.setAttributeNS(null, "height","1000");
			svgg.setAttributeNS(null, "transform", `translate(30,500) scale(${scale},-${scale})`);
			
			//svgMarker.attr({markerWidth:20,markerHeight:20);
			svgPath.setAttributeNS(null, "d", getGlyphSVGpath(glyph));
			svgPath.setAttributeNS(null, "stroke", `black`);
			svgPath.setAttributeNS(null, "stroke-width", `${GLOBAL.vf.config.ui.glyph.strokeWidth}px`);
			svgPath.setAttributeNS(null, "fill", `#eee`);

			svg.appendChild(svgg);

			// glyph
			svgg.appendChild(svgPath);


			glyph.points.forEach(function (pt, p) {
				let size = font.config.ui.point.size;
				if (pt[2]) {
					svgP = SVG("rect");
					svgP.classList.add("ctrl-pt");
					svgP.setAttributeNS(null, "x", pt[0]-size);
					svgP.setAttributeNS(null, "y", pt[1]-size);
					svgP.setAttributeNS(null, "width", 2*size);
					svgP.setAttributeNS(null, "height", 2*size);

				}
				else {
					svgP = SVG("circle");
					svgP.classList.add("ctrl-pt");
					svgP.setAttributeNS(null, "cx", pt[0]);
					svgP.setAttributeNS(null, "cy", pt[1]);
					svgP.setAttributeNS(null, "r", 4);
				}
				svgg.appendChild(svgP);
				/*
				point numbers
				$(svgg).append(
					$(SVG("text"))
						.prop("id", "l-"+p)
						.addClass("point-label")
						.attr({x:pt[0],y:-pt[1],transform:"scale(1,-1) translate(5,0)"})
						.text(p)
				);
				*/
			});



			// x and y axes

			drawing.appendChild(svg);
			

			//drawing.appendChild(glyphFull);

		}

		// display the tvts

		glyph.tvts.forEach((tvt, t) => {

			let li = document.createElement("li");
			li.classList.add("tvt");

			// we mention some stuff about tvt id, then numpoints moved or something, then (aligning with axes in instance panel) an SVG graph for each axis
			li.style.display = "grid";
			li.style.gridTemplateColumns = `1.5em 100px 1.5em repeat(${GLOBAL.vf.axisCount}, 70px)`

			let tvtId = document.createElement("div");
			tvtId.innerText = t;

			let tvtDeltas = document.createElement("div");
			tvtDeltas.innerText = tvt.peak[0]; // JSON.stringify(tvt.deltas);

			let tvtBlank = document.createElement("div");
			tvtBlank.innerText = "x";

			li.appendChild(tvtId);
			li.appendChild(tvtDeltas);
			li.appendChild(tvtBlank);

			// add an svg graph for each axis
			for (let a=0; a<GLOBAL.vf.axisCount; a++) {
				let tvtGraphEl = document.createElement("div");
				let tvtGraph = SVG("svg");
				let svgg = SVG("g");

				tvtGraph.setAttributeNS(null, "width","50");
				tvtGraph.setAttributeNS(null, "height","30");
				svgg.setAttributeNS(null, "transform", `translate(25,25) scale(1,-1)`);


				// draw a graph through start, peak, end for each axis
				let Sx = 20, Sy = 20; // x and y scales

				// draw graph paper
				let pathG = SVG("path");
				//let pathD = pathD = `M ${Sx*-1},0 L ${Sx*tvt.start[a]},0 L ${Sx*tvt.peak[a]},${Sy} L ${Sx*tvt.end[a]},0`;
				pathG.setAttributeNS(null, "fill", "none");
				pathG.setAttributeNS(null, "stroke", "darkgrey");
				pathG.setAttributeNS(null, "stroke-width", "0.5");
				pathG.setAttributeNS(null, "d", `M ${Sx*-1},0 L ${Sx*1},0 M 0,0 L 0,${Sy*1}`);
				svgg.appendChild(pathG);

				// draw tuple start, peak, end data
				if (tvt.peak[a] != 0) { // “When a delta is provided for a region defined by n-tuples that have a peak value of 0 for some axis, then that axis does not factor into scalar calculations.”
					// typicaly graphs are shown at https://docs.microsoft.com/en-us/typography/opentype/spec/otvaroverview
					let path = SVG("path");
					let pathD = `M ${Sx*tvt.start[a]},0 L ${Sx*tvt.peak[a]},${Sy} L ${Sx*tvt.end[a]},0`;
					path.setAttributeNS(null, "fill", "none");
					path.setAttributeNS(null, "stroke", "black");
					path.setAttributeNS(null, "stroke-width", "2");
					path.setAttributeNS(null, "d", pathD);
					svgg.appendChild(path);
				}


				tvtGraph.appendChild(svgg);
				tvtGraphEl.appendChild(tvtGraph);

				tvtGraphEl.style.textAlign = "right";
				li.appendChild(tvtGraphEl);
			}
			


			//panel.innerHTML += JSON.stringify(tvt) + "<br>";

			panel.appendChild(li);

		});


	}



}

function dropHandler(ev) {

// https://developer.mozilla.org/en-US/docs/Web/API/HTML_Drag_and_Drop_API/File_drag_and_drop
  // Prevent default behavior (Prevent file from being opened)
  //alert ('File(s) dropped');
  ev.preventDefault();

  if (ev.dataTransfer.items) {
    // Use DataTransferItemList interface to access the file(s)

    for (var i = 0; i < 1 /* ev.dataTransfer.items.length */ ; i++) { // limit to processing of first file dropped

      // If dropped items aren't files, reject them
      if (ev.dataTransfer.items[i].kind === 'file') {
        var file = ev.dataTransfer.items[i].getAsFile();
        let reader = new FileReader();
        reader.__file__ = file;
        reader.onload = function (event) {

			//console.log (event.target.result);
			//console.log (event.target);
			console.log(this.__file__.size)
			let vf = new SamsaVF({

				arrayBuffer: event.target.result,
				inFile: this.__file__.name,
				filesize: this.__file__.size,
				callback: vfLoaded,
			});
		};
		reader.readAsArrayBuffer(file); // https://stackoverflow.com/questions/22659164/read-a-drag-and-dropped-file
      }
    }
  }
}

document.querySelector("#font-file").addEventListener("drop", dropHandler);
document.querySelector("#font-file").addEventListener("dragover",function(e){
	e = e || event;
	e.preventDefault();
},false);



function SVG(tag) {
    return document.createElementNS('http://www.w3.org/2000/svg', tag);
}



</script>


</body>
</html>