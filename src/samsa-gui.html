<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="utf-8">

<script src="samsa-core.js"></script>

<link rel = "stylesheet" type = "text/css" href = "samsa-gui.css" />
</head>

<body>

<div id="container">

<div id="title"><h1>Samsa</h1>
	<div class="subtitle">
		variable font inspector<br>
		<a href="https://github.com/Lorp/samsa" title="Samsa on GitHub"><img width="15" height="15" src="images/GitHub-Mark-64px.svg"></a>
	</div>
	<div class="subtitle"></div>
</div>

<div id="font-file" class="inactive">
	&lt;drop a variable font here&gt;
</div>

<div id="controls">

	<div id="info" class="panel">
		<h2>Info</h2>
		<div></div>
	</div>

	<div id="axes" class="panel">
		<h2>Axes</h2>
		<div></div>
	</div>

	<div id="instances" class="panel">
		<h2>Instances</h2>
		<div></div>
	</div>

	<div id="tuples" class="panel">
		<h2>Tuple Variations</h2>
		<div></div>
	</div>

	<div id="designspace" class="panel">
		<h2>Designspace</h2>
		<div></div>
	</div>

	<div id="stat" class="panel">
		<h2>STAT</h2>
		<div></div>
	</div>

	<div id="glyphs" class="panel">
		<h2>Glyphs</h2>
		<div></div>
	</div>

</div>

<div id="drawing"></div>

</div>


<script>


let GLOBAL = {
	vf: null, // maybe allow an array of fonts... select them with a drop down in info panel
};



function vfLoaded (font) {

	GLOBAL.vf = font;

	let panel;

	///////////////////////////////////////////////////////
	// info panel
	///////////////////////////////////////////////////////
	panel = document.querySelector("#info>div");
	panel.innerText = "";

	document.querySelector("#font-file").innerText = font.filename; // font.names[6];

	panel.innerHTML += `${font.filename} (${font.filesize || "<em>n</em>"} bytes)<br>`;
	panel.innerHTML += `Full name: ${font.names[4]}<br>`;
	panel.innerHTML += `Other name: ${font.names[1]}<br>`;


	///////////////////////////////////////////////////////
	// axis panel
	///////////////////////////////////////////////////////
	panel = document.querySelector("#axes>div");
	panel.innerText = "";

	document.querySelector("#font-file").innerText = font.filename; // font.names[6];

	// add each axis
	font.axes.forEach((axis, a) => {

		let label =  document.createElement("label");
		label.innerHTML = `<span style="font-weight: bold; font-family: monospace;">${axis.tag}</span> ${axis.name}`;
		panel.appendChild(label);

		let slider = document.createElement("input");
		slider.setAttribute("type", "range");

		let boxes = document.createElement("label");

		panel.appendChild(slider);

	});



	///////////////////////////////////////////////////////
	// instances panel
	///////////////////////////////////////////////////////
	panel = document.querySelector("#instances>div");
	panel.innerText = "";
	panel.style.backgroundClip = "border-box";
	panel.style.padding = "1px 0"; // necessary so the padding of the contents uses the panelâ€™s background-color 

	// add each instance
	font.instances.forEach((instance, i) => {

		let li = document.createElement("div");
		li.classList.add("instance");
		let fvsString = "";
		li.innerHTML += `${instance.name}<br>`;
		li.innerHTML += "&nbsp;&nbsp;&nbsp;[";
		li.innerHTML += instance.tuple.join();
		li.innerHTML += "] ";
		li.innerHTML += JSON.stringify(instance.fvs);
		
		li.innerHTML += "<br>";
		panel.appendChild(li);
		//li.style.padding = "10px";
		//li.style.boxSizing = "content-box";

	});


	///////////////////////////////////////////////////////
	// glyphs panel
	///////////////////////////////////////////////////////
	panel = document.querySelector("#glyphs>div");
	panel.innerText = "";
	let scale = 0.05 * 1000 / font.unitsPerEm;

	for (let g=0; g < font.numGlyphs; g++) {

		let glyph = font.glyphs[g];

		let glyphThumb = document.createElement("div");
		glyphThumb.classList.add("glyph-thumb");
		glyphThumb.setAttribute("id", `g-${g}`);


		if (glyph.numContours > 0) {

			// simple glyph
			let svg = SVG("svg");
			let svgPath = SVG("path");
			let svgg = SVG("g");

			svg.setAttributeNS(null, "width","90");
			svg.setAttributeNS(null, "height","90");
			svgg.setAttributeNS(null, "transform", `translate(30,60) scale(${scale},-${scale})`);
			
			//svgMarker.attr({markerWidth:20,markerHeight:20);

			svgPath.setAttributeNS(null, "d", getGlyphSVGpath(glyph));

			svg.appendChild(svgg);


			// glyph
			svgg.appendChild(svgPath);

			// x and y axes

			glyphThumb.appendChild(svg);
		}
		else if (glyph.numContours < 0) {

		}

		panel.appendChild(glyphThumb);


		let label = document.createElement("label");
		label.innerText = g;

		glyphThumb.appendChild(label);

	}


}



document.onclick = function (event) {

	let glyphThumb;

	if (event.target == document.querySelector("#font-file")) {

		let vf = new SamsaVF({

			fontFamily: "FontNameShouldGoHere",
			url: "fonts/MutatorSans.ttf",
			callback: vfLoaded,
		});
	}

	else if (glyphThumb = event.target.closest(".glyph-thumb")) {

		font = GLOBAL.vf;

		let scale = 0.5 * 1000 / font.unitsPerEm;

		console.log(glyphThumb.id);
		let comps = glyphThumb.id.split("-");
		let g = comps[1];
		let glyph = font.glyphs[g];


		// clear main window
		let drawing = document.querySelector("#drawing");
		drawing.innerHTML = "";

		// append svg

		if (glyph.numContours > 1) {

			let svg = SVG("svg");
			let svgPath = SVG("path");
			let svgg = SVG("g");

			svg.setAttributeNS(null, "width","1000");
			svg.setAttributeNS(null, "height","1000");
			svgg.setAttributeNS(null, "transform", `translate(30,500) scale(${scale},-${scale})`);
			
			//svgMarker.attr({markerWidth:20,markerHeight:20);
			svgPath.setAttributeNS(null, "d", getGlyphSVGpath(glyph));
			svgPath.setAttributeNS(null, "stroke", `black`);
			svgPath.setAttributeNS(null, "stroke-width", `3px`);
			svgPath.setAttributeNS(null, "fill", `#eee`);

			svg.appendChild(svgg);

			// glyph
			svgg.appendChild(svgPath);


			glyph.points.forEach(function (pt, p) {
				let size = font.config.ui.point.size;
				if (pt[2]) {
					svgP = SVG("rect");
					svgP.setAttributeNS(null, "x", pt[0]-size);
					svgP.setAttributeNS(null, "y", pt[1]-size);
					svgP.setAttributeNS(null, "width", 2*size);
					svgP.setAttributeNS(null, "height", 2*size);

				}
				else {
					svgP = SVG("circle");
					svgP.setAttributeNS(null, "cx", pt[0]);
					svgP.setAttributeNS(null, "cy", pt[1]);
					svgP.setAttributeNS(null, "r", 4);
				}
				svgg.appendChild(svgP);
				/*
				point numbers
				$(svgg).append(
					$(SVG("text"))
						.prop("id", "l-"+p)
						.addClass("point-label")
						.attr({x:pt[0],y:-pt[1],transform:"scale(1,-1) translate(5,0)"})
						.text(p)
				);
				*/
			});



			// x and y axes

			drawing.appendChild(svg);
			

			//drawing.appendChild(glyphFull);

		}





	}



}



function dropHandler(ev) {

// https://developer.mozilla.org/en-US/docs/Web/API/HTML_Drag_and_Drop_API/File_drag_and_drop
  // Prevent default behavior (Prevent file from being opened)
  //alert ('File(s) dropped');
  ev.preventDefault();

  if (ev.dataTransfer.items) {
    // Use DataTransferItemList interface to access the file(s)

    for (var i = 0; i < 1 /* ev.dataTransfer.items.length */ ; i++) { // limit to processing of first file dropped

      // If dropped items aren't files, reject them
      if (ev.dataTransfer.items[i].kind === 'file') {
        var file = ev.dataTransfer.items[i].getAsFile();
        let reader = new FileReader();
        reader.__file__ = file;
        reader.onload = function (event) {

			//console.log (event.target.result);
			console.log (event.target);

			let vf = new SamsaVF({

				arrayBuffer: event.target.result,
				inFile: this.__file__.name,
				callback: vfLoaded,
			});
		};
		reader.readAsArrayBuffer(file); // https://stackoverflow.com/questions/22659164/read-a-drag-and-dropped-file
      }
    }
  }
}

document.querySelector("#font-file").addEventListener("drop", dropHandler);
document.querySelector("#font-file").addEventListener("dragover",function(e){
	e = e || event;
	e.preventDefault();
},false);



function SVG(tag) {
    return document.createElementNS('http://www.w3.org/2000/svg', tag);
}



</script>


</body>
</html>